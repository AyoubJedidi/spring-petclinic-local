name: Local Docker Build & Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PROJECT_NAME: petclinic
  JAVA_VERSION: '17'

jobs:
  build-and-test:
    name: Build & Test Docker Image
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¦ Checkout code
      uses: actions/checkout@v3
    
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'maven'
    
    - name: ðŸ”¨ Build with Maven
      run: ./mvnw clean package -DskipTests
    
    - name: ðŸ“Š Test Results
      run: |
        echo "Build artifact:"
        ls -lh target/*.jar
    
    - name: ðŸ“ Create Dockerfile
      run: |
        cat > Dockerfile << 'DOCKERFILE'
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app
COPY target/*.jar app.jar
EXPOSE 8080
ENV JAVA_OPTS="-Xmx512m"
HEALTHCHECK --interval=30s --timeout=3s \
  CMD wget --quiet --tries=1 --spider http://localhost:8080/actuator/health || exit 1
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
DOCKERFILE
    
    - name: ðŸ³ Build Docker image
      run: |
        docker build -t ${{ env.PROJECT_NAME }}:${{ github.sha }} .
        docker tag ${{ env.PROJECT_NAME }}:${{ github.sha }} ${{ env.PROJECT_NAME }}:latest
        
        echo "Docker images built:"
        docker images | grep ${{ env.PROJECT_NAME }}
    
    - name: ðŸ§ª Test Docker container
      run: |
        echo "Starting container..."
        docker run -d \
          --name test-container \
          -p 8080:8080 \
          -e JAVA_OPTS="-Xmx512m" \
          ${{ env.PROJECT_NAME }}:latest
        
        echo "Waiting for application to start..."
        for i in {1..60}; do
          if curl -sf http://localhost:8080 > /dev/null; then
            echo "âœ… Application is running!"
            break
          fi
          if [ $i -eq 60 ]; then
            echo "âŒ Application failed to start"
            docker logs test-container
            exit 1
          fi
          echo "Attempt $i/60..."
          sleep 2
        done
        
        echo "Testing endpoints..."
        curl -f http://localhost:8080 || exit 1
        
        echo "Container logs:"
        docker logs test-container | tail -50
    
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        docker stop test-container || true
        docker rm test-container || true
    
    - name: ðŸ’¾ Save Docker image
      run: |
        docker save ${{ env.PROJECT_NAME }}:latest | gzip > ${{ env.PROJECT_NAME }}-docker-image.tar.gz
        ls -lh ${{ env.PROJECT_NAME }}-docker-image.tar.gz
    
    - name: ðŸ“¤ Upload Docker image artifact
      uses: actions/upload-artifact@v3
      with:
        name: docker-image
        path: ${{ env.PROJECT_NAME }}-docker-image.tar.gz
        retention-days: 7
    
    - name: ðŸ“ Create docker-compose.yml
      run: |
        cat > docker-compose.yml << 'COMPOSE'
version: '3.8'

services:
  petclinic:
    image: petclinic:latest
    container_name: petclinic
    ports:
      - "8080:8080"
    environment:
      - JAVA_OPTS=-Xmx512m
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
COMPOSE
    
    - name: ðŸ“¤ Upload docker-compose.yml
      uses: actions/upload-artifact@v3
      with:
        name: deployment-files
        path: docker-compose.yml
    
    - name: ðŸ“‹ Summary
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… BUILD & TEST SUCCESSFUL"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ðŸ“¦ Docker Image: ${{ env.PROJECT_NAME }}:latest"
        echo "ðŸ“Š Image Size: $(docker images ${{ env.PROJECT_NAME }}:latest --format "{{.Size}}")"
        echo ""
        echo "ðŸš€ To run locally:"
        echo "  1. Download artifact from Actions tab"
        echo "  2. Extract: gunzip petclinic-docker-image.tar.gz"
        echo "  3. Load: docker load < petclinic-docker-image.tar"
        echo "  4. Run: docker run -p 8080:8080 petclinic:latest"
        echo "  5. Open: http://localhost:8080"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
